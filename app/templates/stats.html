{% extends "base.html" %}

{% block title %}Analytics - SOC Email Log{% endblock %}

{% block content %}
<h1 style="color: #3b82f6; margin-bottom: 2rem;"> Threat Analytics</h1>

<div class="stats-grid">
    <div class="stat-card">
        <div class="label">Total Emails Analyzed</div>
        <div class="value">{{ total_emails }}</div>
    </div>
    
    <div class="stat-card">
        <div class="label">Top Threat Domain</div>
        <div class="value" style="font-size: 1.2rem; word-break: break-word;">
            {% if top_domains %}
                {{ top_domains[0][0] }}
            {% else %}
                -
            {% endif %}
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2> Top Sender Domains</h2>
        <p class="text-muted">Domains appearing most frequently in phishing attempts</p>
    </div>
    
    {% if top_domains %}
    <table>
        <thead>
            <tr>
                <th style="width: 80px;">Rank</th>
                <th>Domain</th>
                <th style="width: 120px;">Email Count</th>
                <th style="width: 200px;">Threat Level</th>
            </tr>
        </thead>
        <tbody>
            {% for domain, count in top_domains %}
            <tr>
                <td style="text-align: center; font-weight: bold; color: #3b82f6;">
                    #{{ loop.index }}
                </td>
                <td>
                    <span class="badge badge-info">{{ domain }}</span>
                </td>
                <td style="text-align: center;">
                    <strong style="font-size: 1.2rem; color: #ef4444;">{{ count }}</strong>
                </td>
                <td>
                    <div style="background: #0f1419; height: 24px; border-radius: 12px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%); 
                                    height: 100%; 
                                    width: {{ (count / top_domains[0][1] * 100)|round|int }}%; 
                                    display: flex; 
                                    align-items: center; 
                                    padding-left: 0.5rem;
                                    font-size: 0.75rem;
                                    font-weight: 600;">
                            {% if count >= 5 %}Critical{% elif count >= 3 %}High{% else %}Medium{% endif %}
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div style="margin-top: 1.5rem; padding: 1rem; background: #0f1419; border-radius: 6px; border-left: 3px solid #f59e0b;">
        <strong style="color: #f59e0b;"> Threat Hunting Insight:</strong>
        <p class="text-muted mt-1">
            Domains with high frequency may indicate active phishing campaigns. 
            Consider creating detection rules to automatically flag emails from these domains.
        </p>
    </div>
    {% else %}
    <div style="text-align: center; padding: 2rem;">
        <p class="text-muted">No data available yet. Log more emails to see patterns.</p>
    </div>
    {% endif %}
</div>

<div class="card">
    <div class="card-header">
        <h2>Email Volume Trend (Last 30 Days)</h2>
        <p class="text-muted">Track phishing campaign activity over time</p>
    </div>
    
    {% if recent_by_day %}
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Count</th>
                    <th>Trend</th>
                </tr>
            </thead>
            <tbody>
                {% for date, count in recent_by_day|reverse %}
                <tr>
                    <td>{{ date }}</td>
                    <td><strong>{{ count }}</strong></td>
                    <td>
                        <div style="background: #0f1419; height: 20px; border-radius: 10px; overflow: hidden; min-width: 100px;">
                            {% set width = (count / 10 * 100)|int %}
                            {% if width > 100 %}{% set width = 100 %}{% endif %}
                            <div style="background: #3b82f6; height: 100%; width: {{ width }}%;"></div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 2rem;">
        <p class="text-muted">No activity in the last 30 days</p>
    </div>
    {% endif %}
</div>

<div class="card">
    <div class="card-header">
        <h2> Advanced Analytics (Coming Soon)</h2>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div style="padding: 1.5rem; background: #0f1419; border-radius: 6px; opacity: 0.6;">
            <h4 style="color: #3b82f6;">Campaign Clustering</h4>
            <p class="text-muted mt-1">Group related emails into campaigns using ML</p>
        </div>
        <div style="padding: 1.5rem; background: #0f1419; border-radius: 6px; opacity: 0.6;">
            <h4 style="color: #10b981;">Anomaly Detection</h4>
            <p class="text-muted mt-1">Identify unusual patterns in timing and volume</p>
        </div>
        <div style="padding: 1.5rem; background: #0f1419; border-radius: 6px; opacity: 0.6;">
            <h4 style="color: #f59e0b;">Threat Actor Profiling</h4>
            <p class="text-muted mt-1">Analyze TTPs and infrastructure patterns</p>
        </div>
    </div>
</div>
{% endblock %}