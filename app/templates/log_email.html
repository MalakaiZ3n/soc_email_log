{% extends "base.html" %}

{% block title %}Log Phishing Email - SOC Email Log{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2> Log New Phishing Email</h2>
        <p class="text-muted">Paste email header to automatically extract threat indicators</p>
    </div>
    
    {% if not parsed_data %}
    {# Step 1: Paste and Parse Header #}
    <form method="POST" action="{{ url_for('main.log_email') }}">
        <div class="form-group">
            <label for="raw_header">Email Header (paste here)</label>
            <textarea 
                name="raw_header" 
                id="raw_header" 
                rows="15" 
                placeholder="Paste the full email header here...
                
Example:
From: phisher@suspicious.com
To: victim@company.com
Subject: Urgent: Verify Account
Received: from mail.server.com ([203.0.113.42])
..." 
                required>{{ raw_header if raw_header else '' }}</textarea>
            <small class="text-muted">
                üí° Tip: View email source / Show original to get the full header
            </small>
        </div>
        
        <button type="submit" name="parse_header" class="btn btn-primary">
            üîç Parse Header
        </button>
    </form>
    
    {% else %}
    {# Step 2: Review Parsed Data and Save #}
    
    {# Separate indicators by severity #}
    {% set high_medium_indicators = [] %}
    {% set info_indicators = [] %}
    {% for indicator in parsed_data.suspicious_indicators %}
        {% if indicator.severity == 'Info' %}
            {% set _ = info_indicators.append(indicator) %}
        {% else %}
            {% set _ = high_medium_indicators.append(indicator) %}
        {% endif %}
    {% endfor %}
    
    {# Display actual suspicious indicators (High/Medium) #}
    {% if high_medium_indicators %}
    <div style="background: #7f1d1d; border: 1px solid #991b1b; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
        <strong style="color: #fca5a5;">Suspicious Indicators Detected:</strong>
        <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
        {% for indicator in high_medium_indicators %}
            <li>
                <span class="badge badge-{{ 'danger' if indicator.severity == 'High' else 'warning' }}">
                    {{ indicator.severity }}
                </span>
                {{ indicator.description }}
                <br><small class="text-muted">{{ indicator.threat }}</small>
            </li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    {# Display informational indicators separately (Info) #}
    {% if info_indicators %}
    <div style="background: #1e3a5f; border: 1px solid #2563eb; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
        <strong style="color: #60a5fa;">Manual Verification Recommended:</strong>
        <ul style="margin-top: 0.5rem; margin-left: 1.5rem; color: #cbd5e1;">
        {% for indicator in info_indicators %}
            <li>
                {{ indicator.description }}
                <br><small style="color: #94a3b8;">{{ indicator.threat }}</small>
            </li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    <form method="POST" action="{{ url_for('main.log_email') }}">
        <input type="hidden" name="raw_header" value="{{ raw_header }}">
        
        <h3 style="color: #10b981; margin-bottom: 1rem;">‚úì Extracted Fields</h3>
        
        <div class="grid-2">
            <div class="form-group">
                <label for="from_address">From Address</label>
                <input type="text" name="from_address" id="from_address" 
                       value="{{ parsed_data.from_address }}" required>
            </div>
            
            <div class="form-group">
                <label for="to_address">To Address</label>
                <input type="text" name="to_address" id="to_address" 
                       value="{{ parsed_data.to_address }}" required>
            </div>
        </div>
        
        <div class="form-group">
            <label for="subject">Subject</label>
            <input type="text" name="subject" id="subject" 
                   value="{{ parsed_data.subject }}" required>
        </div>
        
        <div class="grid-2">
            <div class="form-group">
                <label for="sender_domain">Sender Domain</label>
                <input type="text" name="sender_domain" id="sender_domain" 
                       value="{{ parsed_data.sender_domain }}">
            </div>
            
            <div class="form-group">
                <label for="sender_ip">Sender IP</label>
                <input type="text" name="sender_ip" id="sender_ip" 
                       value="{{ parsed_data.sender_ip }}">
            </div>
        </div>
        
        <div class="grid-2">
            <div class="form-group">
                <label for="mail_server">Mail Server</label>
                <input type="text" name="mail_server" id="mail_server" 
                       value="{{ parsed_data.mail_server }}">
            </div>
            
            <div class="form-group">
                <label for="smtp_sender">SMTP Sender (Return-Path)</label>
                <input type="text" name="smtp_sender" id="smtp_sender" 
                       value="{{ parsed_data.smtp_sender }}">
            </div>
        </div>
        
        <div class="form-group">
            <label for="threat_type">Threat Type</label>
            <select name="threat_type" id="threat_type">
                <option value="Phishing">Phishing</option>
                <option value="Malware">Malware</option>
                <option value="Spam">Spam</option>
                <option value="Spoofing">Spoofing</option>
                <option value="Credential Harvesting">Credential Harvesting</option>
                <option value="Business Email Compromise">Business Email Compromise</option>
            </select>
        </div>
        
        <div class="grid-2">
            <div class="form-group">
                <label for="file_hash">üìé Attachment File Hash (MD5/SHA1/SHA256)</label>
                <input type="text" name="file_hash" id="file_hash" 
                       placeholder="e.g., d41d8cd98f00b204e9800998ecf8427e">
                <small class="text-muted">
                    If email has attachment, paste its hash here
                </small>
            </div>
            
            <div class="form-group">
                <label for="virustotal_results"> VirusTotal Results</label>
                <input type="text" name="virustotal_results" id="virustotal_results" 
                       placeholder="e.g., 45/70 detections or VT link">
                <small class="text-muted">
                    Scan results (e.g., "45/70" or link to VT report)
                </small>
            </div>
        </div>
        
        <div class="form-group">
            <label for="analyst_notes">Analyst Notes</label>
            <textarea name="analyst_notes" id="analyst_notes" rows="4" 
                      placeholder="What did you find? Any patterns? Verdict? Recommendations?"></textarea>
            <small class="text-muted">
                Document your findings: What makes this suspicious? Any patterns you noticed? Your verdict?
            </small>
        </div>
        
        <div class="form-group">
            <details style="background: #0f1419; padding: 1rem; border-radius: 6px; border: 1px solid #2a2f3e;">
                <summary style="cursor: pointer; font-weight: 600; color: #9ca3af;">
                     View Raw Header
                </summary>
                <pre style="margin-top: 1rem; max-height: 300px; overflow-y: auto;">{{ raw_header }}</pre>
            </details>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button type="submit" name="save_email" class="btn btn-success">
                ‚úì Save to Database
            </button>
            <a href="{{ url_for('main.log_email') }}" class="btn btn-secondary">
                ‚Üê Start Over
            </a>
        </div>
    </form>
    {% endif %}
</div>

{% if parsed_data %}
<div class="card">
    <div class="card-header">
        <h3> What Happens Next?</h3>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div style="padding: 1rem; background: #0f1419; border-radius: 6px; border-left: 3px solid #3b82f6;">
            <strong style="color: #3b82f6;">IOC Extraction</strong>
            <p class="text-muted mt-1">System will automatically extract domains, IPs, URLs from this email</p>
        </div>
        <div style="padding: 1rem; background: #0f1419; border-radius: 6px; border-left: 3px solid #10b981;">
            <strong style="color: #10b981;">Pattern Analysis</strong>
            <p class="text-muted mt-1">Email will be analyzed for patterns and clustered with similar threats</p>
        </div>
        <div style="padding: 1rem; background: #0f1419; border-radius: 6px; border-left: 3px solid #f59e0b;">
            <strong style="color: #f59e0b;">Enrichment</strong>
            <p class="text-muted mt-1">IOCs can be enriched with threat intelligence data (configure API keys)</p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}